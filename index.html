<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dice Hack Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
    <script>
        // Konfigurasi Masa Kadaluarsa
        const DEFAULT_EXPIRATION_DURATION = 200 * 60 * 1000; // 200 menit dalam milidetik

        // Firebase configuration
        const firebaseConfig = {
            databaseURL: "https://baru1234-67129-default-rtdb.firebaseio.com/"
        };
        
        // Global variable untuk koneksi Firebase
        let dbRef = null;

        // Fungsi untuk menampilkan toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.innerHTML = message;
            toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg shadow-lg transition-all duration-300 
                ${type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}
                animate-bounce`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 500);
            }, 3000);
        }

        // Fungsi untuk memeriksa status masa aktif
        function checkAppExpiration() {
            const expirationTime = parseInt(localStorage.getItem('appExpirationTime'));
            const currentTime = Date.now();

            const expirationBox = document.getElementById('expirationStatus');
            const mainApp = document.querySelector('.bg-white');

            if (currentTime < expirationTime) {
                // Masa aktif normal
                const remainingTime = expirationTime - currentTime;
                const remainingMinutes = Math.floor(remainingTime / (60 * 1000));
                const remainingSeconds = Math.floor((remainingTime % (60 * 1000)) / 1000);

                expirationBox.innerHTML = `
                    <span class="text-green-600 font-bold">
                        Sisa Waktu: ${remainingMinutes} menit ${remainingSeconds} detik
                    </span>
                `;
                mainApp.classList.remove('opacity-50', 'pointer-events-none');
                return true;
            } else {
                // Aplikasi kadaluarsa total
                expirationBox.innerHTML = `
                    <span class="text-red-600 font-bold">
                        APLIKASI KADALUARSA
                    </span>
                `;
                mainApp.classList.add('opacity-50', 'pointer-events-none');
                
                // Nonaktifkan tombol dan input
                document.querySelectorAll('button, input').forEach(el => {
                    el.disabled = true;
                });
                
                // Putuskan koneksi Firebase
                if (dbRef) {
                    dbRef.off(); // Lepaskan semua listener
                }

                // Tambahkan toast notifikasi
                showToast('Aplikasi telah kadaluarsa', 'error');
                document.getElementById('resetSection').style.display = 'block'; // Tampilkan bagian untuk mengatur ulang waktu

                return false;
            }
        }

        // Inisialisasi Firebase
        function initializeFirebase() {
            // Jika belum ada waktu kedaluwarsa, atur dengan default
            if (!localStorage.getItem('appExpirationTime')) {
                const expirationTime = Date.now() + DEFAULT_EXPIRATION_DURATION;
                localStorage.setItem('appExpirationTime', expirationTime);
            }
            
            // Periksa masa aktif sebelum inisialisasi
            if (!checkAppExpiration()) {
                showToast('Aplikasi telah kadaluarsa', 'error');
                return null;
            }

            firebase.initializeApp(firebaseConfig);
            return firebase.database().ref('baucua/');
        }

        // Status koneksi dan pemantauan real-time
        function setupFirebaseConnection() {
            const connectedRef = firebase.database().ref('.info/connected');
            connectedRef.on('value', function(snapshot) {
                const connected = snapshot.val();
                updateConnectionStatus(connected);
            });

            dbRef.on('value', function(snapshot) {
                const data = snapshot.val();
                if (data && data.results) {
                    console.log('Received data:', data.results);
                    displayReceivedData(data.results);
                }
            });
        }

        // Perbarui tampilan status koneksi
        function updateConnectionStatus(isConnected) {
            const statusBox = document.getElementById('connectionStatus');
            if (isConnected) {
                statusBox.innerHTML = `
                    <span class="text-green-500 font-bold">
                        <i class="animate-pulse">ðŸŸ¢ Remot Terhubung</i>
                    </span>
                `;
            } else {
                statusBox.innerHTML = `
                    <span class="text-red-500 font-bold">
                        ðŸ”´ Terputus
                    </span>
                `;
            }
        }

        // Tampilkan data yang diterima
        function displayReceivedData(data) {
            const receivedDataBox = document.getElementById('receivedData');
            receivedDataBox.textContent = `Data Diterima: ${data}`;
            receivedDataBox.classList.add('bg-green-100', 'p-2', 'rounded', 'mt-2');
        }

        // Saat dokumen siap
        $(document).ready(function() {
            // Jalankan pengecekan berkala setiap 1 detik
            const expirationCheck = setInterval(checkAppExpiration, 1000);

            // Inisialisasi koneksi Firebase
            dbRef = initializeFirebase();
            
            if (dbRef) {
                setupFirebaseConnection();
            }

            // Penanganan input angka
            $('.number-btn').click(function() {
                const number = $(this).data('number');
                const currentInput = $('#data');
                currentInput.val(currentInput.val() + number);
            });

            // Fungsionalitas tombol hapus
            $('#deleteBtn').click(function() {
                const currentInput = $('#data');
                currentInput.val(currentInput.val().slice(0, -1));
            });

            // Kirim data ke Firebase
            $('#sendBtn').click(function() {
                if (!checkAppExpiration()) {
                    showToast('Aplikasi kadaluarsa. Tidak dapat mengirim data.', 'error');
                    return;
                }

                const data = $('#data').val();
                if (data) {
                    try {
                        dbRef.set({
                            time: firebase.database.ServerValue.TIMESTAMP,
                            results: data
                        }).then(() => {
                            showToast('Data berhasil terkirim!');
                            $('#data').val(''); // Kosongkan input setelah mengirim
                        }).catch((error) => {
                            showToast('Gagal mengirim data', 'error');
                        });
                    } catch (error) {
                        console.error('Kesalahan Firebase:', error);
                        showToast('Terjadi kesalahan saat mengirim data', 'error');
                    }
                } else {
                    showToast('Masukkan data terlebih dahulu', 'error');
                }
            });

            // Event untuk mengatur ulang waktu kedaluwarsa
            $('#setDuration').click(function() {
                const duration = parseInt($('#duration').val());
                if (!isNaN(duration) && duration > 0) {
                    const expirationTime = Date.now() + (duration * 60 * 1000); // Ubah menit ke milidetik
                    localStorage.setItem('appExpirationTime', expirationTime);
                    showToast(`Durasi aktif diatur menjadi ${duration} menit.`, 'success');

                    $('#resetSection').hide(); // Sembunyikan pengaturan ulang
                    checkAppExpiration(); // Cek ulang status masa aktif
                } else {
                    showToast('Masukkan durasi yang valid.', 'error');
                }
            });
        });
    </script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-100 min-h-screen flex items-center justify-center">
    <div class="bg-white shadow-2xl rounded-2xl p-8 w-96 text-center">
        <h1 class="text-3xl font-bold mb-6 text-purple-700 animate-pulse">Dice Hack Cah Metro</h1>
        
        <div id="expirationStatus" class="mb-4 text-xl"></div>
        
        <div id="connectionStatus" class="mb-4 text-xl"></div>
        
        <div class="mb-4">
            <input 
                type="text" 
                id="data" 
                readonly 
                class="w-full p-2 border-2 border-purple-300 rounded-lg text-center text-2xl bg-purple-50"
                placeholder="Masukkan angka"
            >
        </div>
        
        <div class="grid grid-cols-3 gap-4 mb-4">
            <button data-number="1" class="number-btn bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600 transition">1</button>
            <button data-number="2" class="number-btn bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600 transition">2</button>
            <button data-number="3" class="number-btn bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600 transition">3</button>
            <button data-number="4" class="number-btn bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600 transition">4</button>
            <button data-number="5" class="number-btn bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600 transition">5</button>
            <button data-number="6" class="number-btn bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600 transition">6</button>
        </div>
        
        <div class="flex space-x-4 mb-4">
            <button 
                id="deleteBtn" 
                class="flex-1 bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 transition"
            >
                Hapus
            </button>
            <button 
                id="sendBtn" 
                class="flex-1 bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 transition"
            >
                Kirim
            </button>
        </div>

        <!-- Bagian untuk mengatur ulang waktu kadaluarsa -->
        <div id="resetSection" style="display: none;" class="mb-4">
            <label for="duration" class="text-xl">Masukkan durasi aktif (menit):</label>
            <input 
                type="number" 
                id="duration" 
                class="border-2 border-purple-300 rounded-lg p-2"
                placeholder="Contoh: 200"
            >
            <button id="setDuration" class="bg-blue-500 text-white p-2 rounded-lg">Tetapkan Durasi</button>
        </div>

        <div id="receivedData" class="text-center font-semibold"></div>
    </div>
</body>
</html>
